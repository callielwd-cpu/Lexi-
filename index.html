<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        /* üé® MUDAN√áA APLICADA AQUI: Configura√ß√£o da fonte TTRuns com peso ExtraBold (800) */
        @font-face {
            font-family: 'TTRunsTrialExtraBold';
            /* Se voc√™ tiver o TT Runs Trial ExtraBold.ttf, o URL deve ser:
               src: url('seu-caminho-para/TT Runs Trial ExtraBold.ttf') format('truetype');
               Usei a mesma CDN que voc√™ forneceu, mas com um nome de fam√≠lia mais espec√≠fico.
            */
            src: url('https://fonts.cdnfonts.com/s/32463/TT%20Runs%20Bold.woff') format('woff');
            font-weight: 800; /* ExtraBold geralmente √© 800 */
            font-style: normal;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #101d25;
            color: #e9edef;
        }

        .panel {
            display: none;
            padding: 1rem;
            border-top: 1px solid #374151;
        }

        .panel.active {
            display: block;
        }

        .range-container {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .range-container label {
            width: 150px;
            font-size: 0.875rem;
        }

        .range-container input[type="range"] {
            flex-grow: 1;
            margin: 0 10px;
        }

        .range-container span {
            width: 40px;
            text-align: right;
            font-weight: bold;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
            border-bottom: 1px dashed #374151;
            font-size: 0.875rem;
        }

        /* Estilos do Canvas para arrasto */
        #welcomeCanvas {
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            touch-action: none; /* Impede o scroll touch ao arrastar */
        }
        
        .canvas-draggable {
            cursor: grab;
        }
        
        .dragging {
            cursor: grabbing !important;
        }
    </style>
</head>
<body class="p-4">
    <h1 class="text-3xl font-bold mb-6 text-center text-white">
        üé® Editor de Card <span style="color:#7289da;">Welcome</span>
    </h1>

    <div class="flex flex-col lg:flex-row gap-6 max-w-7xl mx-auto">

        <div class="lg:w-2/3 bg-gray-800 p-4 rounded-xl shadow-lg flex flex-col items-center">
            <h2 class="text-xl font-semibold mb-3">Pr√©-visualiza√ß√£o do Card</h2>
            <canvas id="welcomeCanvas" width="900" height="350" class="w-full lg:w-[900px] h-auto max-h-[350px]"></canvas>

            <button id="toggleMoveModeButton"
                onclick="toggleMoveMode()"
                class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-200 mt-4 w-full lg:w-96">
                Ativar Modo Arrasto
            </button>
        </div>

        <div class="lg:w-1/3 bg-gray-900 p-6 rounded-xl shadow-lg">

            <div class="mb-4">
                <label for="panelSelect" class="block text-sm font-medium mb-1">Selecione o Painel de Ajustes:</label>
                <select id="panelSelect" onchange="onPanelChange()" class="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="panel-help">√çsis Manual ‚ú®</option>
                    <option value="panel-background">Background üñºÔ∏è</option>
                    <option value="panel-positions">Posicionamento (X, Y) ‚öôÔ∏è</option>
                    <option value="panel-text">Texto e Cores üé®</option>
                    <option value="panel-summary">Visualizar e salvar</option>
                </select>
            </div>

            <div id="panel-background" class="panel active">
                <h3 class="text-lg font-bold mb-3">üñºÔ∏è Background</h3>

                <div class="mb-3">
                    <label for="bgUrlInput" class="block text-sm font-medium mb-1">URL da Imagem de Fundo (ou 'false'):</label>
                    <input type="text" id="bgUrlInput" value="false" oninput="updateCanvas()" class="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white">
                </div>

                <div class="mb-3">
                    <label for="bgColorInput" class="block text-sm font-medium mb-1">Cor S√≥lida de Fundo (HEX):</label>
                    <div class="flex items-center gap-2">
                        <input type="color" id="bgColorInput" value="#0b1323" oninput="updateCanvas()" class="h-10 w-10 p-0 border-none rounded-md">
                        <input type="text" id="bgColorHex" value="#0b1323" oninput="document.getElementById('bgColorInput').value=this.value; updateCanvas()" class="flex-grow bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white uppercase">
                    </div>
                </div>

                <hr class="border-gray-700 my-4">

                <h4 class="font-semibold mb-2">Avatares</h4>

                <div class="mb-3">
                    <label for="userPicUrlInput" class="block text-sm font-medium mb-1">Ex perfil usuario:</label>
                    <input type="text" id="userPicUrlInput" value="https://i.ibb.co/N6nNsRYf/lua.gif" oninput="updateCanvas()" class="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white">
                </div>

                <div class="range-container">
                    <label for="userRadius">Raio Usu√°rio:</label>
                    <input type="range" id="userRadius" min="10" max="100" value="66" step="1" oninput="updateCanvas()">
                    <span id="userRadiusValue">66</span>
                </div>

                <div class="mb-3 mt-4">
                    <label for="groupPicUrlInput" class="block text-sm font-medium mb-1">Ex perfil grupo:</label>
                    <input type="text" id="groupPicUrlInput" value="https://i.ibb.co/PsV0zCTw/si.jpg" oninput="updateCanvas()" class="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white">
                </div>

                <div class="range-container">
                    <label for="groupRadius">Raio Grupo:</label>
                    <input type="range" id="groupRadius" min="10" max="100" value="35" step="1" oninput="updateCanvas()">
                    <span id="groupRadiusValue">35</span>
                </div>
            </div>

            <div id="panel-positions" class="panel">
                <h3 class="text-lg font-bold mb-3">üìç Posi√ß√µes Centrais (0-900 / 0-350)</h3>

                <h4 class="font-semibold mb-2 mt-4">Avatar do Usu√°rio</h4>
                <div class="range-container">
                    <label for="userX">Posi√ß√£o X:</label>
                    <input type="range" id="userX" min="0" max="900" value="437" step="1" oninput="updateCanvas()">
                    <span id="userXValue">437</span>
                </div>
                <div class="range-container">
                    <label for="userY">Posi√ß√£o Y:</label>
                    <input type="range" id="userY" min="0" max="350" value="110" step="1" oninput="updateCanvas()">
                    <span id="userYValue">110</span>
                </div>

                <h4 class="font-semibold mb-2 mt-4">Avatar do Grupo</h4>
                <div class="range-container">
                    <label for="groupX">Posi√ß√£o X:</label>
                    <input type="range" id="groupX" min="0" max="900" value="655" step="1" oninput="updateCanvas()">
                    <span id="groupXValue">655</span>
                </div>
                <div class="range-container">
                    <label for="groupY">Posi√ß√£o Y:</label>
                    <input type="range" id="groupY" min="0" max="350" value="300" step="1" oninput="updateCanvas()">
                    <span id="groupYValue">300</span>
                </div>

                <h4 class="font-semibold mb-2 mt-4">Texto de Boas-Vindas (Arrast√°vel)</h4>
                <div class="range-container">
                    <label>Posi√ß√£o X:</label>
                    <span id="welcomeXValue">450</span>
                </div>
                <div class="range-container">
                    <label>Posi√ß√£o Y:</label>
                    <span id="welcomeYValue">230</span>
                </div>

                <h4 class="font-semibold mb-2 mt-4">Box ID (Arrast√°vel)</h4>
                <div class="range-container">
                    <label>Posi√ß√£o X:</label>
                    <span id="idBoxXValue">450</span>
                </div>
                <div class="range-container">
                    <label>Posi√ß√£o Y:</label>
                    <span id="idBoxYValue">310</span>
                </div>
            </div>

            <div id="panel-text" class="panel">
                <h3 class="text-lg font-bold mb-3">üî† Texto e Cores</h3>

                <div class="mb-3">
                    <label for="welcomeTextInput" class="block text-sm font-medium mb-1">Texto de Boas-Vindas:</label>
                    <input type="text" id="welcomeTextInput" value="Bem Vindo(a)" oninput="updateCanvas()" class="w-full bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white">
                </div>

                <div class="range-container mb-3">
                    <label for="welcomeFontSize">Tamanho da Fonte:</label>
                    <input type="range" id="welcomeFontSize" min="20" max="100" value="50" step="1" oninput="updateCanvas()">
                    <span id="welcomeFontSizeValue">50</span>
                </div>

                <div class="mb-3">
                    <label for="welcomeColorInput" class="block text-sm font-medium mb-1">Cor do Texto (Welcome):</label>
                    <div class="flex items-center gap-2">
                        <input type="color" id="welcomeColorInput" value="#ffffff" oninput="updateCanvas()" class="h-10 w-10 p-0 border-none rounded-md">
                        <input type="text" id="welcomeColorHex" value="#ffffff" oninput="document.getElementById('welcomeColorInput').value=this.value; updateCanvas()" class="flex-grow bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white uppercase">
                    </div>
                </div>

                <hr class="border-gray-700 my-4">

                <div class="mb-3">
                    <label for="groupNameColorInput" class="block text-sm font-medium mb-1">Cor do Nome do Grupo:</label>
                    <div class="flex items-center gap-2">
                        <input type="color" id="groupNameColorInput" value="#ffd900" oninput="updateCanvas()" class="h-10 w-10 p-0 border-none rounded-md">
                        <input type="text" id="groupNameColorHex" value="#ffd900" oninput="document.getElementById('groupNameColorInput').value=this.value; updateCanvas()" class="flex-grow bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white uppercase">
                    </div>
                </div>

                <hr class="border-gray-700 my-4">

                <div class="mb-3">
                    <label for="idBoxColorInput" class="block text-sm font-medium mb-1">Cor do Box ID:</label>
                    <div class="flex items-center gap-2">
                        <input type="color" id="idBoxColorInput" value="#454545" oninput="updateCanvas()" class="h-10 w-10 p-0 border-none rounded-md">
                        <input type="text" id="idBoxColorHex" value="#454545" oninput="document.getElementById('idBoxColorInput').value=this.value; updateCanvas()" class="flex-grow bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white uppercase">
                    </div>
                </div>
            </div>

            <div id="panel-help" class="panel bg-gray-900 shadow-2xl rounded-xl p-6 max-w-sm mx-auto transform hover:scale-[1.01] transition duration-300 ease-in-out border border-indigo-700/50">
                <div class="flex items-center justify-start mb-4 border-b border-indigo-800 pb-3">
                    <span class="text-3xl mr-3" role="img" aria-label="Ajuda">‚ú®</span>
                    <h3 class="text-2xl font-extrabold text-white tracking-wider">Help-me</h3>
                </div>

                <div class="w-full mb-5 relative overflow-hidden rounded-xl shadow-lg">
                    <img id="carousel-img" src="https://i.ibb.co/pBN6NM9h/Isis2.png" alt="Assistente Lexi" class="rounded-xl max-w-full transition duration-500 transform">
                </div>

                <div class="text-center text-white text-sm font-medium mt-2">
                    <span id="carousel-text" class="transition-opacity duration-700 opacity-100">
                        Oi! Eu sou <span style="color: #6666FF;">√≠sis</span> üíï
                    </span>
                </div>

                <script>
                    const imagens = [
                        "https://i.ibb.co/Gf4fBpqc/Isis.png",
                        "https://i.ibb.co/JjzFfXx9/Isis1.png",
                        "https://i.ibb.co/0jp956XM/isi34.png",
                        "https://i.ibb.co/fYdy2VJt/cardissi.png",
                        "https://i.ibb.co/Gf4fBpqc/Isis.png"
                    ];

                    const textos = [
                        'Melhor Bot <span style="color:#25D366;">whatsapp</span> com welcome.',
                        '√â hora de <span style="color:#B7FF00;">brilhar</span> no seu grupo! üåü',
                        'Personaliza√ß√£o‚ú®',
                        'D√™ <span style="color:#EEFF00;">boas-vindas</span> com estilo! üéâ',
                        'Vamos criar algo <span style="color:#FF8C00;">incr√≠vel?</span> üíñ'
                    ];

                    let index = 0;
                    const img = document.getElementById("carousel-img");
                    const txt = document.getElementById("carousel-text");

                    setInterval(() => {
                        index = (index + 1) % imagens.length;
                        img.classList.add("opacity-0");
                        txt.classList.add("opacity-0");

                        setTimeout(() => {
                            img.src = imagens[index];
                            txt.innerHTML = textos[index]; // ‚úÖ agora o <span> √© renderizado com cor
                            img.classList.remove("opacity-0");
                            txt.classList.remove("opacity-0");
                        }, 700);
                    }, 3500);
                </script>


                <p class="text-sm mb-4 font-semibold italic" style="color:#a78bfa;">
                    üõ†Ô∏è Bem-vindo(a) ao seu centro de configura√ß√µes! Veja o que voc√™ pode otimizar:
                </p>

                <ul class="space-y-3 mb-6">
                    <li class="flex items-start text-sm text-gray-200">
                        <span class="text-indigo-400 mr-3 mt-1">‚óè</span>
                        <div>
                            <strong class="text-[#37ff77]">üñºÔ∏è Background:</strong>
                            Ajuste do perfil de usu√°rio, perfil do grupo e imagem de fundo. Caso n√£o queira usar imagem, deixe 'false'. Para cor s√≥lida, use o c√≥digo HEX.
                        </div>
                    </li>
                    <li class="flex items-start text-sm text-gray-200">
                        <span class="text-indigo-400 mr-3 mt-1">‚óè</span>
                        <div>
                            <strong class="text-[#37ff77]">Posicionamento X e Y:</strong>
                            Visualize as posi√ß√µes e par√¢metros do seu card em tempo real.
                        </div>
                    </li>
                    <li class="flex items-start text-sm text-gray-200">
                        <span class="text-indigo-400 mr-3 mt-1">‚óè</span>
                        <div>
                            <strong class="text-[#37ff77]">üî† Texto e Cores:</strong>
                            Personalize o texto, tamanho da fonte e cores do grupo e Box.
                        </div>
                    </li>
                    <li class="flex items-start text-sm text-gray-200">
                        <span class="text-indigo-400 mr-3 mt-1">‚óè</span>
                        <div>
                            <strong class="text-[#7da565]">Visualiza√ß√£o e Salvar:</strong>
                            Veja tudo antes de copiar o modelo e enviar com o comando.
                        </div>
                    </li>
                </ul>

                <div class="mt-6 bg-indigo-900/40 p-5 rounded-xl border border-indigo-700">
                    <div class="flex items-center mb-2">
                        <span class="text-lg text-indigo-400 font-extrabold mr-2">üí°</span>
                        <span class="font-bold text-white text-base">Pronto para usar o modelo?</span>
                    </div>
                    <p class="text-sm text-indigo-200 mt-1">
                        Lembre-se: finalize e use o comando <strong class="text-white">"!cardwelcome"</strong> com o c√≥digo copiado no menu <strong class="text-white">"Visualizar e salvar"</strong>.
                    </p>

                    <a href="https://seusite.com/salvar" class="w-full block text-center mt-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg shadow-indigo-500/50 transition duration-200 transform hover:scale-[1.02] active:scale-[0.98]">
                        Mais detalhes
                    </a>
                </div>
            </div>

            <div id="panel-summary" class="panel">
                <h3 class="text-lg font-bold mb-3">üìä Resumo dos Ajustes</h3>
                <div id="summary-content" class="mb-4 bg-gray-800 p-3 rounded-md">Carregando resumo...</div>

                <button onclick="copyConfigAsJson()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-200 w-full mt-2">
                    üìã Copiar JSON para a √Årea de Transfer√™ncia
                </button>

                <button onclick="exportConfigAsJson()" class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded transition duration-200 w-full mt-2">
                    ‚¨áÔ∏è Exportar Config (.json)
                </button>

                <button onclick="copyConfigAsBase64()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded transition duration-200 w-full mt-2">
                    üîë Copiar meu modelo
                </button>
            </div>
        </div>
    </div>
</body>

<script>
    const FIXED_USER_NAME = 'Sarah_Jones#7489';
    const FIXED_GROUP_NAME = 'Grup √≠sis‚ú®';
    const USER_FALLBACK_COLOR = '#43B581';
    const GROUP_FALLBACK_COLOR = '#ED4245';
    const STORAGE_SELECTED_PANEL_KEY = 'welcome_canvas_selected_panel';
    
    // üü¢ Constantes para Smart Guides
    const ALIGN_TOLERANCE = 5; // Toler√¢ncia de pixels para o alinhamento
    const CANVAS_CENTER_X = 450;
    const CANVAS_CENTER_Y = 175;
    let activeGuides = { centerX: false, centerY: false, alignX: null, alignY: null };
    // ----------------------------------------

    /* üé® MUDAN√áA APLICADA AQUI: Alterando o nome da fonte para o novo nome/peso */
    const getWelcomeFont = () => {
        const size = document.getElementById('welcomeFontSize').value;
        return `800 ${size}px TTRunsTrialExtraBold, sans-serif`; 
    };
    const DEFAULT_FONT = '28px Inter, sans-serif';

    // --- VARI√ÅVEIS DE ESTADO DE ARRASTO ---
    let isDragging = false;
    let draggedElement = null;
    let dragOffsetX = 0;
    let dragOffsetY = 0;
    let isMoveModeActive = false;
    // ----------------------------------------

    // Estado das posi√ß√µes (atualizado pelos ranges e pelo drag)
    let state = {
        userX: 437, userY: 110,
        groupX: 655, groupY: 300,
        welcomeX: 450, welcomeY: 230,
        idBoxX: 450, idBoxY: 310
    };

    const canvas = document.getElementById('welcomeCanvas');
    const ctx = canvas.getContext('2d');

    function initializeState() {
        state.userX = parseInt(document.getElementById('userX').value);
        state.userY = parseInt(document.getElementById('userY').value);
        state.groupX = parseInt(document.getElementById('groupX').value);
        state.groupY = parseInt(document.getElementById('groupY').value);
        state.welcomeX = 450; 
        state.welcomeY = 230;
        state.idBoxX = 450;
        state.idBoxY = 310;
    }

    // --- FUN√á√ïES DE CARREGAMENTO E DESENHO DE IMAGEM ---

    const loadImageAsync = (url) => {
        return new Promise((resolve) => {
            if (!url || url.trim() === '' || url.trim().toLowerCase() === 'false') return resolve(null);
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.onload = () => resolve(img);
            img.onerror = () => { console.error(`[INFO] Falha ao carregar imagem: ${url}`); resolve(null); };
            img.src = url;
        });
    };

    const drawCircularImage = (ctx, x, y, radius, image, fallbackColor) => {
        ctx.save();
        ctx.beginPath();
        ctx.arc(x, y, radius, 0, Math.PI * 2, true);
        ctx.fillStyle = fallbackColor;
        ctx.fill();
        ctx.closePath();
        ctx.restore();

        if (image) {
            ctx.save();
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2, true);
            ctx.closePath();
            ctx.clip();

            const imgWidth = image.width;
            const imgHeight = image.height;
            const targetSize = radius * 2;
            let sx, sy, sWidth, sHeight;
            const imgRatio = imgWidth / imgHeight;
            const targetRatio = 1;

            if (imgRatio > targetRatio) {
                sHeight = imgHeight;
                sWidth = imgHeight * targetRatio;
                sx = (imgWidth - sWidth) / 2;
                sy = 0;
            } else {
                sWidth = imgWidth;
                sHeight = imgWidth / targetRatio;
                sx = 0;
                sy = (imgHeight - sHeight) / 2;
            }

            const dx = x - radius;
            const dy = y - radius;
            const dWidth = targetSize;
            const dHeight = targetSize;

            ctx.drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);
            ctx.restore();
        }
    };

    // --- FUN√á√ïES DE ARRASTO E HIT TEST ---
    
    function getMousePos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
            x: (clientX - rect.left) * scaleX,
            y: (clientY - rect.top) * scaleY
        };
    }

    function getElementBounds(ctx, config) {
        const WELCOME_TEXT = document.getElementById('welcomeTextInput').value;
        const ID_TEXT = FIXED_USER_NAME;

        const userAvatarBounds = { x: state.userX, y: state.userY, radius: config.userRadius };
        const groupAvatarBounds = { x: state.groupX, y: state.groupY, radius: config.groupRadius };

        const fontSize = document.getElementById('welcomeFontSize').value;
        ctx.font = getWelcomeFont();
        const welcomeMetrics = ctx.measureText(WELCOME_TEXT);
        const welcomeWidth = welcomeMetrics.width;
        const welcomeHeight = parseInt(fontSize) * 1.1; 
        const welcomeBounds = {
            x: state.welcomeX - welcomeWidth / 2, 
            y: state.welcomeY - welcomeHeight,
            width: welcomeWidth,
            height: welcomeHeight 
        };

        ctx.font = DEFAULT_FONT;
        const idMetrics = ctx.measureText(ID_TEXT);
        const boxPaddingX = 20;
        const boxPaddingY = 10;
        const boxWidth = idMetrics.width + boxPaddingX * 2;
        const boxHeight = 28 + boxPaddingY * 2;
        const idBoxBounds = {
            x: state.idBoxX - boxWidth / 2,
            y: state.idBoxY - boxHeight / 2,
            width: boxWidth,
            height: boxHeight
        };

        return { welcome: welcomeBounds, idbox: idBoxBounds, userAvatar: userAvatarBounds, groupAvatar: groupAvatarBounds };
    }

    function hitTest(x, y, bounds) {
        return x >= bounds.x && x <= bounds.x + bounds.width &&
               y >= bounds.y && y <= bounds.y + bounds.height;
    }

    function hitTestCircle(x, y, circleBounds) {
        const dx = x - circleBounds.x;
        const dy = y - circleBounds.y;
        return (dx * dx + dy * dy) <= (circleBounds.radius * circleBounds.radius);
    }

    function startDrag(e) {
        if (!isMoveModeActive) {
            if (e.touches) { e.preventDefault(); }
            return; 
        }

        e.preventDefault(); 
        
        const pos = getMousePos(e);
        const bounds = getElementBounds(ctx, getCurrentConfig()); 

        if (hitTest(pos.x, pos.y, bounds.idbox)) {
            draggedElement = 'idBox';
            dragOffsetX = pos.x - state.idBoxX;
            dragOffsetY = pos.y - state.idBoxY;
        } else if (hitTest(pos.x, pos.y, bounds.welcome)) {
            draggedElement = 'welcomeText';
            dragOffsetX = pos.x - state.welcomeX;
            dragOffsetY = pos.y - state.welcomeY;
        } 
        else if (hitTestCircle(pos.x, pos.y, bounds.userAvatar)) {
            draggedElement = 'userAvatar';
            dragOffsetX = pos.x - state.userX;
            dragOffsetY = pos.y - state.userY;
        } 
        else if (hitTestCircle(pos.x, pos.y, bounds.groupAvatar)) {
            draggedElement = 'groupAvatar';
            dragOffsetX = pos.x - state.groupX;
            dragOffsetY = pos.y - state.groupY;
        } else {
            draggedElement = null;
            return;
        }

        isDragging = true;
        canvas.classList.add('dragging');
    }

    // üü¢ FUN√á√ÉO DRAG COM SMART GUIDES
    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();

        const pos = getMousePos(e);
        let newX = pos.x - dragOffsetX;
        let newY = pos.y - dragOffsetY;
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;

        activeGuides = { centerX: false, centerY: false, alignX: null, alignY: null };

        // 1. Aplicar alinhamento ao centro do Canvas
        if (Math.abs(newX - CANVAS_CENTER_X) < ALIGN_TOLERANCE) {
            newX = CANVAS_CENTER_X;
            activeGuides.centerX = true;
        }
        if (Math.abs(newY - CANVAS_CENTER_Y) < ALIGN_TOLERANCE) {
            newY = CANVAS_CENTER_Y;
            activeGuides.centerY = true;
        }

        // 2. Aplicar alinhamento a outros elementos
        const allElements = ['userAvatar', 'groupAvatar', 'welcomeText', 'idBox'];
        const otherElements = allElements.filter(el => el !== draggedElement);
        const currentConfig = getCurrentConfig();

        const elementCenters = {
            userAvatar: { x: currentConfig.userX, y: currentConfig.userY },
            groupAvatar: { x: currentConfig.groupX, y: currentConfig.groupY },
            welcomeText: { x: currentConfig.welcomeX, y: currentConfig.welcomeY },
            idBox: { x: currentConfig.idBoxX, y: currentConfig.idBoxY }
        };

        for (const otherElement of otherElements) {
            const targetX = elementCenters[otherElement].x;
            const targetY = elementCenters[otherElement].y;

            if (Math.abs(newY - targetY) < ALIGN_TOLERANCE) {
                newY = targetY;
                activeGuides.alignY = targetY;
            }

            if (Math.abs(newX - targetX) < ALIGN_TOLERANCE) {
                newX = targetX;
                activeGuides.alignX = targetX;
            }
        }
        
        // 3. Atualizar o estado do elemento arrastado
        switch (draggedElement) {
            case 'userAvatar':
                state.userX = Math.max(50, Math.min(canvasWidth - 50, newX));
                state.userY = Math.max(50, Math.min(canvasHeight - 50, newY));
                updateRangeFromState('userX', state.userX);
                updateRangeFromState('userY', state.userY);
                break;
            case 'groupAvatar':
                state.groupX = Math.max(20, Math.min(canvasWidth - 20, newX));
                state.groupY = Math.max(20, Math.min(canvasHeight - 20, newY));
                updateRangeFromState('groupX', state.groupX);
                updateRangeFromState('groupY', state.groupY);
                break;
            case 'welcomeText':
                state.welcomeX = Math.max(0, Math.min(canvasWidth, newX));
                state.welcomeY = Math.max(0, Math.min(canvasHeight, newY));
                break;
            case 'idBox':
                state.idBoxX = Math.max(0, Math.min(canvasWidth, newX));
                state.idBoxY = Math.max(0, Math.min(canvasHeight, newY));
                break;
        }

        updateCanvas();
    }

    function endDrag(e) {
        if (isDragging) {
            isDragging = false;
            draggedElement = null;
            canvas.classList.remove('dragging');
            activeGuides = { centerX: false, centerY: false, alignX: null, alignY: null }; 
            updateCanvas(); 
        }
    }
    
    // Event Listeners para Desktop e Mobile
    canvas.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove', drag);
    window.addEventListener('mouseup', endDrag);
    canvas.addEventListener('touchstart', startDrag, { passive: false });
    window.addEventListener('touchmove', drag, { passive: false });
    window.addEventListener('touchend', endDrag);
    
    // --- FUN√á√ïES DE GUIAS E MODO MOVER ---
    
    function drawSmartGuides() {
        if (!isDragging || !isMoveModeActive) return;

        ctx.save();
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);

        // Guia Central Vertical do Canvas (Amarelo)
        if (activeGuides.centerX) {
            ctx.strokeStyle = '#FFD900';
            ctx.beginPath();
            ctx.moveTo(CANVAS_CENTER_X, 0);
            ctx.lineTo(CANVAS_CENTER_X, canvas.height);
            ctx.stroke();
        }

        // Guia Central Horizontal do Canvas (Amarelo)
        if (activeGuides.centerY) {
            ctx.strokeStyle = '#FFD900';
            ctx.beginPath();
            ctx.moveTo(0, CANVAS_CENTER_Y);
            ctx.lineTo(canvas.width, CANVAS_CENTER_Y);
            ctx.stroke();
        }

        // Guia de Alinhamento entre elementos (Verde)
        if (activeGuides.alignX !== null) {
            ctx.strokeStyle = '#00B09C';
            ctx.beginPath();
            ctx.moveTo(activeGuides.alignX, 0);
            ctx.lineTo(activeGuides.alignX, canvas.height);
            ctx.stroke();
        }

        if (activeGuides.alignY !== null) {
            ctx.strokeStyle = '#00B09C';
            ctx.beginPath();
            ctx.moveTo(0, activeGuides.alignY);
            ctx.lineTo(canvas.width, activeGuides.alignY);
            ctx.stroke();
        }

        ctx.restore();
    }
    
    function toggleMoveMode() {
        isMoveModeActive = !isMoveModeActive;
        const button = document.getElementById('toggleMoveModeButton');
        
        if (isMoveModeActive) {
            button.textContent = 'Desativar Modo Arrasto';
            button.style.backgroundColor = '#8419F7'; 
            button.style.color = '#101D25';
            canvas.classList.add('canvas-draggable');
            canvas.style.cursor = 'grab'; 
        } else {
            button.textContent = 'Ativar Modo Arrasto';
            button.style.backgroundColor = '#374151'; 
            button.style.color = '#E9EDEF';
            canvas.classList.remove('canvas-draggable');
            canvas.style.cursor = 'default'; 
            activeGuides = { centerX: false, centerY: false, alignX: null, alignY: null };
            updateCanvas();
        }
    }
    
    // --- FUN√á√ÉO PRINCIPAL DE DESENHO ---
    
    async function drawWelcomeCanvas(config) {
        const userPicUrl = document.getElementById('userPicUrlInput').value;
        const groupPicUrl = document.getElementById('groupPicUrlInput').value;

        const { bgUrl, bgColor, userRadius, groupRadius } = config;

        const userX = state.userX, userY = state.userY, groupX = state.groupX, groupY = state.groupY,
             welcomeX = state.welcomeX, welcomeY = state.welcomeY, idBoxX = state.idBoxX, idBoxY = state.idBoxY;

        const WELCOME_TEXT = document.getElementById('welcomeTextInput').value;
        const WELCOME_COLOR = document.getElementById('welcomeColorInput').value;
        const GROUP_NAME_COLOR = document.getElementById('groupNameColorInput').value;
        const ID_BOX_COLOR_BASE = document.getElementById('idBoxColorInput').value;
        const ID_BOX_COLOR = ID_BOX_COLOR_BASE + "E6"; // 90% opacidade

        const WELCOME_FONT = getWelcomeFont();

        const canvasWidth = canvas.width; const canvasHeight = canvas.height;

        /* üé® MUDAN√áA APLICADA AQUI: Carregamento da fonte com o novo nome */
        try { await document.fonts.load(`800 100px TTRunsTrialExtraBold`); } catch (err) { /* Falha silenciosa */ }

        // Carregamento de Imagens
        const [bgImage, userPicData, groupPicData] = await Promise.all([
            loadImageAsync(bgUrl), loadImageAsync(userPicUrl), loadImageAsync(groupPicUrl)
        ]);

        // 1. Fundo
        if (bgImage) {
            const imgWidth = bgImage.width, imgHeight = bgImage.height;
            const canvasRatio = canvasWidth / canvasHeight, imgRatio = imgWidth / imgHeight;
            let drawW, drawH, offsetX, offsetY;
            if (imgRatio > canvasRatio) {
                drawH = canvasHeight;
                drawW = imgWidth * (canvasHeight / imgHeight);
                offsetX = (canvasWidth - drawW) / 2; offsetY = 0;
            } else {
                drawW = canvasWidth;
                drawH = imgHeight * (canvasWidth / imgWidth);
                offsetX = 0; offsetY = (canvasHeight - drawH) / 2;
            }
            ctx.drawImage(bgImage, offsetX, offsetY, drawW, drawH);
        } else {
            ctx.fillStyle = bgColor; ctx.fillRect(0,0,canvasWidth,canvasHeight);
        }

        // Desenho de detalhes abstratos
        ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
        ctx.beginPath();
        ctx.arc(canvasWidth * 0.1, canvasHeight * 0.9, 100, 0, Math.PI * 2);
        ctx.arc(canvasWidth * 0.9, canvasHeight * 0.1, 70, 0, Math.PI * 2);
        ctx.fill();

        // 2. Fotos de Perfil
        drawCircularImage(ctx, userX, userY, userRadius, userPicData, USER_FALLBACK_COLOR);
        drawCircularImage(ctx, groupX, groupY, groupRadius, groupPicData, GROUP_FALLBACK_COLOR);

        // 3. Nome do Grupo (Fixo)
        const X_GROUP_NAME = groupX + groupRadius + 15;
        const Y_GROUP_NAME = groupY + 10;
        ctx.font = 'bold 30px Inter, sans-serif';
        ctx.textAlign = 'left';
        ctx.fillStyle = GROUP_NAME_COLOR;
        ctx.fillText(FIXED_GROUP_NAME, X_GROUP_NAME, Y_GROUP_NAME);

        // 4. Texto de Boas-Vindas (Arrast√°vel)
        ctx.font = WELCOME_FONT;
        ctx.textAlign = 'center';
        ctx.fillStyle = WELCOME_COLOR;
        ctx.fillText(WELCOME_TEXT, welcomeX, welcomeY);

        // 5. Box de ID (Arrast√°vel)
        const ID_TEXT = FIXED_USER_NAME;
        ctx.font = DEFAULT_FONT;
        const textMetrics = ctx.measureText(ID_TEXT);
        const boxPaddingX = 20, boxPaddingY = 10;
        const boxWidth = textMetrics.width + boxPaddingX * 2;
        const boxHeight = 28 + boxPaddingY * 2;
        const boxX = idBoxX - boxWidth / 2, boxY = idBoxY - boxHeight / 2;
        const borderRadius = 8;

        ctx.fillStyle = ID_BOX_COLOR;
        ctx.beginPath();
        ctx.moveTo(boxX + borderRadius, boxY);
        ctx.lineTo(boxX + boxWidth - borderRadius, boxY);
        ctx.arcTo(boxX + boxWidth, boxY, boxX + boxWidth, boxY + borderRadius, borderRadius);
        ctx.lineTo(boxX + boxWidth, boxY + boxHeight - borderRadius);
        ctx.arcTo(boxX + boxWidth, boxY + boxHeight, boxX + boxWidth - borderRadius, boxY + boxHeight, borderRadius);
        ctx.lineTo(boxX + borderRadius, boxY + boxHeight);
        ctx.arcTo(boxX, boxY + boxHeight, boxX, boxY + boxHeight - borderRadius, borderRadius);
        ctx.lineTo(boxX, boxY + borderRadius);
        ctx.arcTo(boxX, boxY, boxX + borderRadius, boxY, borderRadius);
        ctx.fill();

        const textBaselineY = idBoxY + (28 / 2) - 2;
        ctx.fillStyle = '#FFFFFF';
        ctx.textAlign = 'center';
        ctx.font = DEFAULT_FONT;
        ctx.fillText(ID_TEXT, idBoxX, textBaselineY);

        // Desenha as guias inteligentes POR CIMA
        drawSmartGuides();
    }
    
    // --- FUN√á√ïES DE CONFIGURA√á√ÉO E SINCRONIZA√á√ÉO ---

    function getCurrentConfig() {
        return {
            bgUrl: document.getElementById('bgUrlInput').value,
            bgColor: document.getElementById('bgColorInput').value,
            welcomeText: document.getElementById('welcomeTextInput').value,
            welcomeColor: document.getElementById('welcomeColorInput').value,
            groupNameColor: document.getElementById('groupNameColorInput').value,
            idBoxColor: document.getElementById('idBoxColorInput').value,
            userRadius: parseInt(document.getElementById('userRadius').value),
            groupRadius: parseInt(document.getElementById('groupRadius').value),
            welcomeFontSize: parseInt(document.getElementById('welcomeFontSize').value),
            userX: Math.round(state.userX),
            userY: Math.round(state.userY),
            groupX: Math.round(state.groupX),
            groupY: Math.round(state.groupY),
            welcomeX: Math.round(state.welcomeX),
            welcomeY: Math.round(state.welcomeY),
            idBoxX: Math.round(state.idBoxX),
            idBoxY: Math.round(state.idBoxY),
        };
    }

    function updateRangeFromState(id, value) {
        const input = document.getElementById(id);
        const valueSpan = document.getElementById(id + 'Value');
        if (input && valueSpan) {
            input.value = Math.round(value);
            valueSpan.textContent = Math.round(value);
        }
    }
    
    function updateCanvas() {
        // Sincronizar sliders com spans
        ['userRadius', 'groupRadius', 'welcomeFontSize'].forEach(id => {
            document.getElementById(id + 'Value').textContent = document.getElementById(id).value;
        });
        
        // Sincronizar cor picker com hex input
        const bgColorInput = document.getElementById('bgColorInput');
        document.getElementById('bgColorHex').value = bgColorInput.value;

        // Sincronizar posi√ß√µes arrast√°veis
        document.getElementById('welcomeXValue').textContent = Math.round(state.welcomeX);
        document.getElementById('welcomeYValue').textContent = Math.round(state.welcomeY);
        document.getElementById('idBoxXValue').textContent = Math.round(state.idBoxX);
        document.getElementById('idBoxYValue').textContent = Math.round(state.idBoxY);
        
        // Atualizar canvas
        drawWelcomeCanvas(getCurrentConfig());

        // Atualizar resumo (se o painel estiver ativo)
        if (document.getElementById('panel-summary').classList.contains('active')) {
            updateSummary();
        }
    }

    function updateSummary() {
        const config = getCurrentConfig();
        const summary = `
            <div class="summary-item"><span>Fundo URL:</span> <span>${config.bgUrl}</span></div>
            <div class="summary-item"><span>Fundo Cor:</span> <span>${config.bgColor}</span></div>
            <div class="summary-item"><span>Texto Boas-Vindas:</span> <span>${config.welcomeText}</span></div>
            <div class="summary-item"><span>Cor Welcome:</span> <span>${config.welcomeColor}</span></div>
            <div class="summary-item"><span>Cor Nome Grupo:</span> <span>${config.groupNameColor}</span></div>
            <div class="summary-item"><span>Cor Box ID:</span> <span>${config.idBoxColor}</span></div>
            <div class="summary-item"><span>Raio Usu√°rio:</span> <span>${config.userRadius}px</span></div>
            <div class="summary-item"><span>Raio Grupo:</span> <span>${config.groupRadius}px</span></div>
            <div class="summary-item"><span>Tamanho Fonte:</span> <span>${config.welcomeFontSize}px</span></div>
            <hr class="border-gray-700 my-2">
            <div class="summary-item"><span>Posi√ß√£o User (X, Y):</span> <span>${config.userX}, ${config.userY}</span></div>
            <div class="summary-item"><span>Posi√ß√£o Group (X, Y):</span> <span>${config.groupX}, ${config.groupY}</span></div>
            <div class="summary-item"><span>Posi√ß√£o Welcome (X, Y):</span> <span>${config.welcomeX}, ${config.welcomeY}</span></div>
            <div class="summary-item"><span>Posi√ß√£o ID Box (X, Y):</span> <span>${config.idBoxX}, ${config.idBoxY}</span></div>
        `;
        document.getElementById('summary-content').innerHTML = summary;
    }

    // üåü NOVA FUN√á√ÉO: Copia a configura√ß√£o como Base64
    function copyConfigAsBase64() {
        const config = getCurrentConfig();
        
        // 1. Converte o objeto config em uma string JSON minificada
        const jsonString = JSON.stringify(config); 
        
        // 2. Codifica a string JSON para Base64 (btoa)
        try {
            const base64String = btoa(jsonString);
            
            // 3. Copia a string Base64 para a √°rea de transfer√™ncia
            navigator.clipboard.writeText(base64String).then(() => {
                alert('Configura√ß√£o codificada em Base64 copiada para a √°rea de transfer√™ncia!');
            }).catch(err => {
                console.error('Falha ao copiar Base64:', err);
                alert('Falha ao copiar o Base64. Veja o console para detalhes.');
            });
            
        } catch (e) {
            console.error('Erro de Codifica√ß√£o Base64:', e);
            alert('Erro ao codificar a configura√ß√£o em Base64.');
        }
    }
    
    // Fun√ß√£o original de c√≥pia JSON (mantida por compatibilidade e utilidade)
    function copyConfigAsJson() {
        const config = getCurrentConfig();
        
        // JSON minificado (linha √∫nica)
        const jsonConfig = JSON.stringify(config); 
        
        navigator.clipboard.writeText(jsonConfig).then(() => {
            alert('JSON da configura√ß√£o copiado para a √°rea de transfer√™ncia! (Formato de linha √∫nica)');
        }).catch(err => {
            console.error('Falha ao copiar:', err);
            alert('Falha ao copiar. Veja o console para detalhes.');
        });
    }

    function exportConfigAsJson() {
        const config = getCurrentConfig();
        
        // O terceiro argumento √© '2' para formata√ß√£o leg√≠vel (para o arquivo)
        const jsonConfig = JSON.stringify(config, null, 2); 
        
        const blob = new Blob([jsonConfig], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'welcome_card_config.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    
    function onPanelChange() {
        const selectedPanelId = document.getElementById('panelSelect').value;
        document.querySelectorAll('.panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById(selectedPanelId).classList.add('active');
        localStorage.setItem(STORAGE_SELECTED_PANEL_KEY, selectedPanelId);
        
        if (selectedPanelId === 'panel-summary') {
            updateSummary();
        }
    }
    
    function loadSavedPanel() {
        const savedPanelId = localStorage.getItem(STORAGE_SELECTED_PANEL_KEY);
        if (savedPanelId && document.getElementById(savedPanelId)) {
            document.getElementById('panelSelect').value = savedPanelId;
            onPanelChange();
        } else {
            document.getElementById('panel-background').classList.add('active');
        }
    }

    // Inicializa√ß√£o
    window.onload = () => {
        initializeState();
        loadSavedPanel();
        updateCanvas();
        
        // Sincronizar ranges com spans no carregamento
        ['userRadius', 'groupRadius', 'userX', 'userY', 'groupX', 'groupY', 'welcomeFontSize'].forEach(id => {
             document.getElementById(id).oninput();
        });
        
        // Sincronizar cor hex com color picker
        document.getElementById('bgColorInput').addEventListener('input', () => {
            document.getElementById('bgColorHex').value = document.getElementById('bgColorInput').value.toUpperCase();
            updateCanvas();
        });
        document.getElementById('welcomeColorInput').addEventListener('input', () => {
            document.getElementById('welcomeColorHex').value = document.getElementById('welcomeColorInput').value.toUpperCase();
            updateCanvas();
        });
        document.getElementById('groupNameColorInput').addEventListener('input', () => {
            document.getElementById('groupNameColorHex').value = document.getElementById('groupNameColorInput').value.toUpperCase();
            updateCanvas();
        });
        document.getElementById('idBoxColorInput').addEventListener('input', () => {
            document.getElementById('idBoxColorHex').value = document.getElementById('idBoxColorInput').value.toUpperCase();
            updateCanvas();
        });

    };
</script>
</body>
</html>